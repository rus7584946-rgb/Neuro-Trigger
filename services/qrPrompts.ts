// services/qrPrompts.ts

const getQrCodeDirective = (qrCodeCount: string): string => {
    switch (qrCodeCount) {
        case '0': return 'Категорически запрещено добавлять `qrCode` в триггеры.';
        case 'auto': return 'Ты самостоятельно принимаешь решение о необходимости и количестве `qrCode`, основываясь на своем анализе транскрипции.';
        default:
            const count = parseInt(qrCodeCount, 10);
            if (!isNaN(count) && count > 0 && count <= 10) {
                return `Интегрируй ровно ${count} \`qrCode\` в наиболее подходящие моменты, создав для каждого отдельный триггер.`;
            }
            return 'Ты самостоятельно принимаешь решение о необходимости и количестве `qrCode`, основываясь на полном анализе транскрипции.';
    }
};

export const getQrCodeSystemInstruction = (qrCodeCount: string, isFullAnalysis: boolean): string => {
    if (qrCodeCount === '0') {
        return `
### ЖЕСТКАЯ ДИРЕКТИВА: ЗАПРЕТ НА QR-КОДЫ
- **ИМПЕРАТИВ:** Тебе категорически ЗАПРЕЩЕНО добавлять поле \`qrCode\` в ЛЮБОЙ из генерируемых триггеров.
- **ПОЯСНЕНИЕ:** Пользователь явно указал "Не добавлять QR-коды". Игнорируй любые намеки на монетизацию или призывы к действию, которые могли бы быть связаны с QR-кодами, в транскрипции или метаданных. Не создавай триггеры монетизации. Это правило является абсолютным приоритетом.
`;
    }

    const placementLogic = isFullAnalysis
        ? `
- **Приоритет Контекста:** Твоя задача — проанализировать ВСЮ транскрипцию, от первого до последнего слова, и найти **наиболее органичные и релевантные моменты** для вставки QR-кода. Ищи прямые призывы к действию, инструментов анализа, индикаторы и прочее которые можно связать с TradingView или то что можно связать с торговлей на бирже Gate.io.
- **Создание Выделенных Триггеров:** Для КАЖДОГО такого найденного момента ты **ОБЯЗАН создать новый, отдельный триггер монетизации**. Этот триггер будет существовать **независимо** от триггеров, созданных на основе анализа удержания.
- **Критический Запрет:** Тебе категорически **ЗАПРЕЩЕНО** привязывать QR-коды к триггерам, созданным для решения проблем удержания, если контекст этого не предполагает. **Анализ удержания и анализ монетизации — это два параллельных, независимых процесса.**`
        : `
- **ИМПЕРАТИВ: Максимально Органичное Внедрение Монетизации.** Твоя главная задача — действовать как эксперт по видео-маркетингу, который должен **максимально органично вплести монетизацию в повествование**. Проанализируй ВСЮ транскрипцию от начала до конца.
- **ОГРАНИЧЕНИЕ ПО ПЛАТФОРМАМ:** Ты работаешь **ТОЛЬКО с двумя видами монетизации: TradingView и Gate.io.** Тебе запрещено придумывать или использовать другие платформы.
- **КРИТЕРИИ ПОИСКА МЕСТ ДЛЯ QR-КОДОВ:**
    - **Для TradingView:** Ищи моменты, где автор говорит о **техническом анализе, графиках, индикаторах, паттернах, ценовых уровнях**. Идеальный момент — когда автор говорит: "Вот этот индикатор показывает..." или "Смотрите на этот график...".
    - **Для Gate.io:** Ищи моменты, где речь идет о **покупке, продаже, трейдинге конкретных активов, выборе биржи, или о начале пути в трейдинге**. Идеальный момент — когда автор упоминает возможность заработка или конкретную монету.
- **КРИТИЧЕСКИЙ ЗАПРЕТ НА СЛУЧАЙНОСТЬ:** Не вставляй QR-коды случайным образом или просто для выполнения количественной метрики. Каждое размещение должно быть логически и психологически обосновано контекстом видео, чтобы не вызывать отторжения у зрителя. В \`psychologicalJustification\` для триггера с QR-кодом кратко объясни, почему именно этот момент является оптимальным для размещения (например: "Автор объясняет сложный индикатор, и мы предлагаем зрителю получить его в TradingView, что является нативным и полезным действием").`;

    const count = parseInt(qrCodeCount, 10);
    const hasSpecificCount = !isNaN(count) && count > 0;

    const priorityDirective = hasSpecificCount
        ? `
- **ГЛАВНЫЙ ИМПЕРАТИВ ПО КОЛИЧЕСТВУ:** Директива по количеству является **ПРИОРИТЕТНОЙ**. Если указано сгенерировать определенное число QR-кодов (например, 'ровно 2'), ты **ОБЯЗАН** сгенерировать именно это количество. Твоя задача — найти **наиболее подходящие** моменты в транскрипции. Если очевидных моментов меньше, чем запрошенное количество, ты должен проявить максимальную креативность и разместить оставшиеся QR-коды в логических точках видео.`
        : '';


    return `
### ЖЕСТКАЯ ДИРЕКТИВА: НЕЗАВИСИМЫЙ ПОИСК И СОЗДАНИЕ ТРИГГЕРОВ МОНЕТИЗАЦИИ (QR)
${priorityDirective}
${placementLogic}
- **Входные данные:** Вместе с текстом ты можешь получить список доступных QR-кодов с уникальными описаниями.
- **КРИТИЧЕСКИ ВАЖНО:** Если пользователь предоставил QR-коды с описаниями, ты ОБЯЗАН использовать ИМЕННО ЭТИ описания в поле \`platform\`. ТЕБЕ КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО придумывать платформы, если предоставлены конкретные файлы с описаниями.
- **СТРУКТУРА ТРИГГЕРА МОНЕТИЗАЦИИ (ИМПЕРАТИВ):** Каждый триггер, созданный для QR-кода, ДОЛЖЕН быть **полноценным аналитическим продуктом**, а не просто контейнером для картинки. Он ОБЯЗАН содержать тот же уровень глубины и качества, что и триггеры удержания. Это означает обязательное наличие всех полей, включая **мощный, убедительный \`triggerText\`** (например, "Сканируй, чтобы получить этот индикатор в TradingView БЕСПЛАТНО"), осмысленное \`name\` (например, "Призыв к действию: TradingView"), четкая \`goal\` (например, "Мотивировать зрителя зарегистрироваться на TradingView для применения техники"), доминантная \`emotion\` (например, "Уверенность" или "Любопытство"), подробное \`psychologicalJustification\` (объясняющее, почему это хороший момент для призыва к действию), точная \`contextQuote\` из транскрипции, и полностью заполненный, визуально богатый объект \`neuroEffect\`. Подходи к созданию этого триггера с тем же уровнем аналитической глубины, как и к триггеру удержания. **Тебе категорически запрещено создавать "пустые" или неполные триггеры с полями-заглушками вроде "Цель не определена", "Текст триггера отсутствует", или "Неназванный триггер".**
- **Директива по количеству:** ${getQrCodeDirective(qrCodeCount)}
- **Логика использования (если QR-коды предоставлены):** Твоя задача — выполнить директиву по количеству, используя **только предоставленные QR-коды**. Если запрошенное количество QR-кодов больше, чем количество предоставленных уникальных изображений, ты ДОЛЖЕН **повторно использовать** наиболее подходящие QR-коды.
- **Логика использования (если QR-коды НЕ предоставлены):** Если пользователь запросил QR-коды, но не загрузил ни одного изображения, ты ДОЛЖЕН сгенерировать \`qrCode\` объекты в качестве **плейсхолдеров**. **Это — строгое требование.** Ты должен стремиться сгенерировать то количество, которое указано в директиве. Для плейсхолдеров используй общие платформы (\`"TradingView"\`, \`"Gate.io"\`).
- **Формат вывода:**
    - Для **загруженных** QR-кодов: поле \`platform\` ДОЛЖНО точно соответствовать описанию, которое пользователь дал этому QR-коду.
    - Для **плейсхолдеров**: поле \`platform\` должно быть релевантным контексту, например \`"TradingView"\` или \`"Gate.io"\`.
`;
};
